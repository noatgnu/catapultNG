import{a as w}from"./chunk-7ITMQ6SW.js";import{L as S,f as _,g as m,h as b,i as y,j as C,l as p}from"./chunk-VG74EQIO.js";var k={url:"",deserializer:a=>JSON.parse(a.data),serializer:a=>JSON.stringify(a)},L="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",u=class a extends C{constructor(t,i){if(super(),this._socket=null,t instanceof b)this.destination=i,this.source=t;else{let n=this._config=Object.assign({},k);if(this._output=new y,typeof t=="string")n.url=t;else for(let c in t)t.hasOwnProperty(c)&&(n[c]=t[c]);if(!n.WebSocketCtor&&WebSocket)n.WebSocketCtor=WebSocket;else if(!n.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new p}}lift(t){let i=new a(this._config,this.destination);return i.operator=t,i.source=this,i}_resetState(){this._socket=null,this.source||(this.destination=new p),this._output=new y}multiplex(t,i,n){let c=this;return new b(o=>{try{c.next(t())}catch(r){o.error(r)}let e=c.subscribe({next:r=>{try{n(r)&&o.next(r)}catch(s){o.error(s)}},error:r=>o.error(r),complete:()=>o.complete()});return()=>{try{c.next(i())}catch(r){o.error(r)}e.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:t,protocol:i,url:n,binaryType:c}=this._config,o=this._output,e=null;try{e=i?new t(n,i):new t(n),this._socket=e,c&&(this._socket.binaryType=c)}catch(s){o.error(s);return}let r=new _(()=>{this._socket=null,e&&e.readyState===1&&e.close()});e.onopen=s=>{let{_socket:h}=this;if(!h){e.close(),this._resetState();return}let{openObserver:g}=this._config;g&&g.next(s);let d=this.destination;this.destination=m.create(l=>{if(e.readyState===1)try{let{serializer:f}=this._config;e.send(f(l))}catch(f){this.destination.error(f)}},l=>{let{closingObserver:f}=this._config;f&&f.next(void 0),l&&l.code?e.close(l.code,l.reason):o.error(new TypeError(L)),this._resetState()},()=>{let{closingObserver:l}=this._config;l&&l.next(void 0),e.close(),this._resetState()}),d&&d instanceof p&&r.add(d.subscribe(this.destination))},e.onerror=s=>{this._resetState(),o.error(s)},e.onclose=s=>{e===this._socket&&this._resetState();let{closeObserver:h}=this._config;h&&h.next(s),s.wasClean?o.complete():o.error(s)},e.onmessage=s=>{try{let{deserializer:h}=this._config;o.next(h(s))}catch(h){o.error(h)}}}_subscribe(t){let{source:i}=this;return i?i.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(()=>{let{_socket:n}=this;this._output.observers.length===0&&(n&&(n.readyState===1||n.readyState===0)&&n.close(),this._resetState())}),t)}unsubscribe(){let{_socket:t}=this;t&&(t.readyState===1||t.readyState===0)&&t.close(),this._resetState(),super.unsubscribe()}};var R=(()=>{let t=class t{constructor(){this.personalID=crypto.randomUUID(),this.connectingNotificationChannel=!1,this.connectingAnalysisLogChannel=!1,this.protocol=window.location.protocol,this.baseURL=w.baseURL.replace("http://","https://").replace("http","ws")}connectNotification(){return this.connectingNotificationChannel=!0,this.notificationConnection?(this.connectingNotificationChannel=!1,this.notificationConnection):(this.notificationConnection=new u({url:`${this.baseURL}/ws/notification/alert/${this.personalID}/`,openObserver:{next:()=>{console.log("Connected to notification channel")}},closeObserver:{next:()=>{console.log("Closed connection to notification channel")}}}),this.connectingNotificationChannel=!1,this.notificationConnection)}connectAnalysisLog(){return this.connectingAnalysisLogChannel=!0,this.analysisLogConnection?(this.connectingAnalysisLogChannel=!1,this.analysisLogConnection):(this.analysisLogConnection=new u({url:`${this.baseURL}/ws/log/analysis_log/`,openObserver:{next:()=>{console.log("Connected to analysis log channel")}},closeObserver:{next:()=>{console.log("Closed connection to analysis log channel")}}}),this.connectingAnalysisLogChannel=!1,this.analysisLogConnection)}disconnectNotification(){this.notificationConnection?.complete(),this.notificationConnection=void 0}disconnectAnalysisLog(){this.analysisLogConnection?.complete(),this.analysisLogConnection=void 0}};t.\u0275fac=function(c){return new(c||t)},t.\u0275prov=S({token:t,factory:t.\u0275fac,providedIn:"root"});let a=t;return a})();export{R as a};
